name: Ephemeral Staging

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to stage (branch, tag, or SHA)"
        required: true
        default: "main"
      keep:
        description: "Keep droplet for debugging"
        required: true
        type: choice
        default: "false"
        options: ["false", "true"]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: richmiles-xyz-ephemeral-staging-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: false

jobs:
  stage:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/stage') && github.actor == github.repository_owner)
    runs-on: ubuntu-latest
    env:
      SPARK_SWARM_API_URL: https://swarm.sparkswarm.com/api/v1
    steps:
      - name: Resolve PR ref (issue_comment only)
        if: ${{ github.event_name == 'issue_comment' }}
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            core.setOutput('pr_number', String(prNumber));
            core.setOutput('ref', pr.data.head.sha);

      - name: Resolve ref (workflow_dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        id: manual
        run: |
          echo "ref=${{ github.event.inputs.ref }}" >> "$GITHUB_OUTPUT"

      - name: Checkout (target ref)
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.ref || steps.manual.outputs.ref }}

      - name: Compute image tag
        id: meta
        shell: bash
        run: |
          short_sha="$(git rev-parse --short=7 HEAD)"
          echo "short_sha=$short_sha" >> "$GITHUB_OUTPUT"
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "tag=pr-${{ steps.pr.outputs.pr_number }}-${short_sha}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=sha-${short_sha}" >> "$GITHUB_OUTPUT"
          fi

      - uses: docker/setup-buildx-action@v3

      - name: Build image (linux/amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: false
          load: true
          platforms: linux/amd64
          tags: richmiles-xyz:${{ steps.meta.outputs.tag }}

      - name: Export image tarball
        run: |
          docker save "richmiles-xyz:${{ steps.meta.outputs.tag }}" -o image.tar

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_API_TOKEN }}

      - name: Checkout Spark Swarm runner
        uses: actions/checkout@v4
        with:
          repository: richmiles/spark-swarm
          path: spark-swarm
          ssh-key: ${{ secrets.SPARK_SWARM_DEPLOY_KEY }}
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Stage
        id: stage
        env:
          SPARK_SWARM_API_KEY: ${{ secrets.SPARK_SWARM_API_KEY }}
        run: |
          image="richmiles-xyz:${{ steps.meta.outputs.tag }}"
          ref="${{ steps.pr.outputs.ref || steps.manual.outputs.ref }}"
          keep="${{ github.event.inputs.keep || 'false' }}"

          args=(
            --pack deploy/pack.toml
            --image "$image"
            --image-tar image.tar
            --ref "$ref"
            --summary-out stage-summary.json
          )
          if [[ "$keep" == "true" ]]; then
            args+=(--keep)
          fi

          python3 spark-swarm/runner/ephemeral_stage.py "${args[@]}"

      - name: Upload summary
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: stage-summary
          path: stage-summary.json
          retention-days: 7

      - name: Comment on PR (issue_comment only)
        if: ${{ always() && github.event_name == 'issue_comment' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('stage-summary.json', 'utf8'));
            const ok = summary.success ? '✅' : '❌';
            const url = summary.url || '(no url)';
            const err = summary.error ? `\n\nError:\n\`\`\`\n${summary.error}\n\`\`\`\n` : '';
            const checks = (summary.checks || [])
              .map(c => `- ${c.ok ? '✅' : '❌'} ${c.name} (${c.type})${c.url ? ` - ${c.url}` : ''}`)
              .join('\n');
            const body = [
              `${ok} Ephemeral staging **${summary.success ? 'passed' : 'failed'}**`,
              ``,
              `- Ref: \`${summary.ref}\``,
              `- URL: ${url}`,
              ``,
              `Checks:`,
              checks || '- (none)',
              err,
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body,
            });
